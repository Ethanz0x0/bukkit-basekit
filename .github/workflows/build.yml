name: Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Set up JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3. Extract full version from Maven
      - name: Extract full version from Maven
        id: fullver
        run: |
          VER=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "ver=$VER" >> $GITHUB_OUTPUT

      # 4. Extract main version (strip build numbers / suffixes)
      - name: Extract main version
        id: mainver
        run: |
          MAIN=$(echo "${{ steps.fullver.outputs.ver }}" | sed 's/[-+].*//')
          echo "ver=$MAIN" >> $GITHUB_OUTPUT

      # 5. Auto create tag only if not exists
      - name: Create tag if not exists
        run: |
          TAG="v${{ steps.mainver.outputs.ver }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping tag creation."
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

      # 6. Generate changelog from [CL]
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)

          if [ -z "$LAST_TAG" ]; then
            RANGE=""
            LOG=$(git log --pretty=format:"%s")
          else
            RANGE="$LAST_TAG..HEAD"
            LOG=$(git log $RANGE --pretty=format:"%s")
          fi

          FINAL=""
          while IFS= read -r line; do
            PREFIX=$(echo "$line" | sed 's/^\(\[CL\]\).*/\1/i')
            if echo "$PREFIX" | grep -qi "\[CL\]"; then
              CONTENT=$(echo "$line" | sed 's/^[[]CL[]]//I' | sed 's/^[ \t]*//')
              FINAL="$FINAL\n- $CONTENT"
            fi
          done <<< "$LOG"

          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FINAL" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 7. Build JAR
      - name: Build with Maven
        run: mvn -B clean package

      # 8. Collect JAR file
      - name: Locate JAR file
        id: jarfile
        run: |
          FILE=$(find target -maxdepth 1 -type f -name "*.jar" | head -n 1)
          echo "file=$FILE" >> $GITHUB_OUTPUT

      # 9. Publish GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.mainver.outputs.ver }}
          files: |
            ${{ steps.jarfile.outputs.file }}
          body: |
            ## Changelog
            ${{ steps.changelog.outputs.result }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
