name: Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup JDK 8
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      # 3. Read main version from pom.xml
      - name: Read main version from pom.xml
        id: read_version
        run: |
          MAIN_VERSION=$(grep -oPm1 "(?<=<version>)[^<]+" pom.xml | head -n1)
          echo "main_version=$MAIN_VERSION" >> $GITHUB_OUTPUT

      # 4. Determine build number
      - name: Determine build number
        id: build_number
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          LAST_BUILD=$(gh release view "$MAIN_VERSION" --json assets --jq '.assets[].name' 2>/dev/null | grep -oP "(?<=${MAIN_VERSION}-)\d+(?=\.jar)" | sort -n | tail -1)
          if [ -z "$LAST_BUILD" ]; then
            BUILD_NUMBER=1
          else
            BUILD_NUMBER=$((LAST_BUILD + 1))
          fi
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      # 5. Rewrite plugin.yml version
      - name: Rewrite plugin.yml version
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          sed -i "s/version: .*/version: ${MAIN_VERSION}/" src/main/resources/plugin.yml

      # 6. Set BUILD_NUMBER env
      - name: Set build number env
        run: echo "BUILD_NUMBER=${{ steps.build_number.outputs.build_number }}" >> $GITHUB_ENV

      # 7. Maven build
      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      # 8. Rename shaded artifact
      - name: Rename artifact
        id: rename
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          BUILD_NUMBER=${{ steps.build_number.outputs.build_number }}
          OUT="BaseKit-${MAIN_VERSION}-${BUILD_NUMBER}.jar"
          JAR=$(ls target/*-shaded.jar | head -n1)
          cp "$JAR" "$OUT"
          echo "artifact=$OUT" >> $GITHUB_OUTPUT

      # 9. Extract Changelog from recent commits
      - name: Extract Changelog
        id: changelog
        run: |
          COMMITS=$(git log -n 20 --pretty=format:"%s")
          CHANGELOG=""
          while read -r line; do
            if echo "$line" | grep -iq "^\[CL\]"; then
              ITEM=$(echo "$line" | sed -E 's/^\[CL\]\s*//I')
              CHANGELOG="${CHANGELOG}${ITEM}\n"
            fi
          done <<< "$COMMITS"
          echo -e "$CHANGELOG" > extracted_changelog.txt

      # 10. Merge Changelog and format
      - name: Merge Changelog and format
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}

          # 获取旧的 Release notes（如果有）
          gh release view "$MAIN_VERSION" --json body --jq '.body' > old_body.txt 2>/dev/null || true

          # 提取旧 changelog（跳过大标题行）
          OLD_CHANGELOG=$(awk 'NR>1' old_body.txt || true)

          # 合并新旧 changelog 去重
          MERGED=$(cat old_body.txt extracted_changelog.txt | sed '/^$/d' | sort -u)

          # 写入 final_body.txt，带大标题和列表
          {
            echo "# Changelog"
            echo ""
            while read -r line; do
              if [ -n "$line" ]; then
                echo "- $line"
              fi
            done <<< "$MERGED"
          } > final_body.txt

      # 11. Create or Update Release
      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          ARTIFACT=${{ steps.rename.outputs.artifact }}

          if gh release view "$MAIN_VERSION" >/dev/null 2>&1; then
            # release 已存在，只上传新的 artifact
            gh release upload "$MAIN_VERSION" "$ARTIFACT"
            # 更新 notes（累积 changelog）
            gh release edit "$MAIN_VERSION" --notes-file final_body.txt
          else
            # release 不存在，新建
            gh release create "$MAIN_VERSION" "$ARTIFACT" --title "$MAIN_VERSION" --notes-file final_body.txt
          fi