name: Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Java 17
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          architecture: x64

      # Force set JAVA_HOME
      - name: Force JAVA_HOME
        run: |
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "$JAVA_HOME/bin" >> $GITHUB_PATH

      # Print current java version
      - name: Check Java Version
        run: java -version

      # Read main version from pom.xml
      - name: Read main version
        id: read_version
        run: |
          MAIN_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "main_version=$MAIN_VERSION" >> $GITHUB_OUTPUT

      # Get short commit SHA as internal build number
      - name: Get commit SHA
        id: commit_sha
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      # Rewrite plugin.yml version
      - name: Rewrite plugin.yml version
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          sed -i "s/^version: .*/version: ${MAIN_VERSION}/" src/main/resources/plugin.yml

      # Build with Maven
      - name: Build with Maven
        run: |
          COMMIT_SHA=${{ steps.commit_sha.outputs.commit_sha }}
          mvn -B clean package -DskipTests -DbuildNumber=$COMMIT_SHA

      # Prepare Release artifact
      - name: Prepare Release artifact
        id: prepare_artifact
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          SHADOW_JAR=$(ls target/*-shaded.jar | head -n1)
          RELEASE_FILE="BaseKit-${MAIN_VERSION}.jar"
          cp "$SHADOW_JAR" "$RELEASE_FILE"
          echo "release_artifact=$RELEASE_FILE" >> $GITHUB_OUTPUT

      # Extract Changelog from recent commits
      - name: Extract Changelog
        id: extract_changelog
        run: |
          BEFORE_SHA=${{ github.event.before }}
          AFTER_SHA=${{ github.event.after }}

          > extracted_changelog.txt
          HAS_CL=false

          if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            COMMITS=$(git log -n 10 --pretty=format:"%B")
          else
            COMMITS=$(git log $BEFORE_SHA..$AFTER_SHA --pretty=format:"%B")
          fi

          while IFS= read -r line; do
            if echo "$line" | grep -iq "^\[CL\]"; then
              ITEM=$(echo "$line" | sed -E 's/^\[CL\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_changelog.txt
              HAS_CL=true
            fi
          done <<< "$COMMITS"

          echo "has_cl=$HAS_CL" >> $GITHUB_OUTPUT

      # Merge Changelog (ONLY if this push has [CL])
      - name: Merge Changelog
        if: steps.extract_changelog.outputs.has_cl == 'true'
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}

          gh release view "$MAIN_VERSION" --json body --jq '.body' > old_body.txt 2>/dev/null || true

          MERGED=$(cat old_body.txt extracted_changelog.txt | sed '/^$/d' | sort -u)

          > final_body.txt
          echo "# Changelog" >> final_body.txt
          echo "" >> final_body.txt

          while IFS= read -r line; do
            echo "- $line" >> final_body.txt
          done <<< "$MERGED"

      # Create or Update Release
      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          RELEASE_FILE=${{ steps.prepare_artifact.outputs.release_artifact }}
          HAS_CL=${{ steps.extract_changelog.outputs.has_cl }}

          if gh release view "$MAIN_VERSION" >/dev/null 2>&1; then
            gh release upload "$MAIN_VERSION" "$RELEASE_FILE" --clobber

            if [ "$HAS_CL" = "true" ]; then
              gh release edit "$MAIN_VERSION" --notes-file final_body.txt
            fi
          else
            if [ "$HAS_CL" = "true" ]; then
              gh release create "$MAIN_VERSION" "$RELEASE_FILE" \
                --title "$MAIN_VERSION" \
                --notes-file final_body.txt
            else
              gh release create "$MAIN_VERSION" "$RELEASE_FILE" \
                --title "$MAIN_VERSION"
            fi
          fi