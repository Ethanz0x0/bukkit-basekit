name: Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write # ÂøÖÈ°ªË¶ÅÊúâÂÜôÂÖ•ÊùÉÈôêÊâçËÉΩÂàõÂª∫/Êõ¥Êñ∞ Release

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Á°Æ‰øùËé∑ÂèñÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩï‰ª•ËøõË°å git log

      # Setup Java 17
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          architecture: x64

      # Force set JAVA_HOME
      - name: Force JAVA_HOME
        run: |
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "$JAVA_HOME/bin" >> $GITHUB_PATH

      # Print current java version
      - name: Check Java Version
        run: java -version

      # Read main version from pom.xml
      - name: Read main version
        id: read_version
        run: |
          MAIN_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "main_version=$MAIN_VERSION" >> $GITHUB_OUTPUT

      # Get short commit SHA as internal build number
      - name: Get commit SHA
        id: commit_sha
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      # Rewrite plugin.yml version
      - name: Rewrite plugin.yml version
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          sed -i "s/^version: .*/version: ${MAIN_VERSION}/" src/main/resources/plugin.yml

      # Build with Maven (internal build number passed as property)
      - name: Build with Maven
        run: |
          COMMIT_SHA=${{ steps.commit_sha.outputs.commit_sha }}
          mvn -B clean package -DskipTests -DbuildNumber=$COMMIT_SHA

      # Prepare Release artifact
      - name: Prepare Release artifact
        id: prepare_artifact
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          SHADOW_JAR=$(ls target/*-shaded.jar | head -n1)
          RELEASE_FILE="BaseKit-${MAIN_VERSION}.jar"
          cp "$SHADOW_JAR" "$RELEASE_FILE"
          echo "release_artifact=$RELEASE_FILE" >> $GITHUB_OUTPUT

      # --- üöÄ Â¢ûÂº∫ÂêéÁöÑ Changelog ÊèêÂèñ ---
      - name: Extract Changelog
        id: extract_changelog
        run: |
          BEFORE_SHA=${{ github.event.before }}
          AFTER_SHA=${{ github.event.after }}

          # ÂàùÂßãÂåñÁ©∫Êñá‰ª∂
          > extracted_add.txt
          > extracted_remove.txt
          > extracted_fix.txt
          > extracted_other.txt
          
          if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "Detected initial push or force push ‚Äî using last 10 commits"
            COMMITS=$(git log -n 10 --pretty=format:"%B")
          else
            COMMITS=$(git log $BEFORE_SHA..$AFTER_SHA --pretty=format:"%B")
          fi
          
          # Âæ™ÁéØÂ§ÑÁêÜÊâÄÊúâÊèê‰∫§‰ø°ÊÅØ
          while IFS= read -r line; do
            # ÂéªÈô§ÂâçÂêéÁ©∫Ê†º
            CLEAN_LINE=$(echo "$line" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')

            if echo "$CLEAN_LINE" | grep -iq "^\[ADD\]"; then
              ITEM=$(echo "$CLEAN_LINE" | sed -E 's/^\[ADD\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_add.txt
            elif echo "$CLEAN_LINE" | grep -iq "^\[REMOVE\]"; then
              ITEM=$(echo "$CLEAN_LINE" | sed -E 's/^\[REMOVE\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_remove.txt
            elif echo "$CLEAN_LINE" | grep -iq "^\[FIX\]"; then
              ITEM=$(echo "$CLEAN_LINE" | sed -E 's/^\[FIX\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_fix.txt
            elif echo "$CLEAN_LINE" | grep -iq "^\[OTHER\]"; then
              ITEM=$(echo "$CLEAN_LINE" | sed -E 's/^\[OTHER\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_other.txt
            fi
          done <<< "$COMMITS"

      # --- üöÄ Â¢ûÂº∫ÂêéÁöÑ Changelog ÂêàÂπ∂ÂíåÊ†ºÂºèÂåñ (Èò≤Ë¶ÜÁõñ) ---
      - name: Merge Changelog
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          
          # Â∞ùËØïËé∑ÂèñÂΩìÂâç Release ÁöÑ body
          gh release view "$MAIN_VERSION" --json body --jq '.body' > old_body.txt 2>/dev/null || true
          
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÁöÑ Changelog ÂÜÖÂÆπË¢´ÊèêÂèñ (‰ªª‰∏ÄÊñá‰ª∂ÈùûÁ©∫Âç≥ÊúâÊñ∞ÂÜÖÂÆπ)
          if [ -s extracted_add.txt ] || [ -s extracted_remove.txt ] || [ -s extracted_fix.txt ] || [ -s extracted_other.txt ]; then
              HAS_NEW_CHANGES=true
          else
              HAS_NEW_CHANGES=false
          fi
          
          # --- Èò≤Ë¶ÜÁõñÈÄªËæëÔºöÂ¶ÇÊûúÊó†Êñ∞ÂèòÊõ¥ÔºåÂàô‰øùÁïôÊóßÂÜÖÂÆπ ---
          if [ "$HAS_NEW_CHANGES" = false ] && [ -s old_body.txt ]; then
              echo "No new [ADD/REMOVE/FIX/OTHER] tags found. Retaining existing Release body."
              cp old_body.txt final_body.txt
          
          # --- ÊúâÊñ∞ÂèòÊõ¥ÊàñÊóßÂÜÖÂÆπ‰∏∫Á©∫ÔºåÈáçÊñ∞ÁîüÊàê body ---
          else
              > final_body.txt
          
              # 1. ÂÜôÂÖ•Ê†áÈ¢ò
              echo "# Changelog" >> final_body.txt
              echo "" >> final_body.txt
          
              # 2. ‰øùÁïô Release ‰∏≠ÂèØËÉΩÂ≠òÂú®ÁöÑÊ†áÈ¢òÊàñÈùûÂàóË°®ÊèèËø∞ÊñáÂ≠ó
              if [ -s old_body.txt ]; then
                  # ÊèêÂèñ old_body.txt ‰∏≠Âú® "# Changelog" Ê†áÈ¢ò‰πãÂâçÁöÑÊâÄÊúâÂÜÖÂÆπ
                  OLD_PRE_BODY=$(cat old_body.txt | sed '/^# Changelog/,$d')
                  if [ -n "$OLD_PRE_BODY" ]; then
                      printf "%s\n\n" "$OLD_PRE_BODY" >> final_body.txt
                  fi
              fi

              # ÂÆö‰πâ‰∏Ä‰∏™ÂáΩÊï∞ÔºåÁî®‰∫éÊ†ºÂºèÂåñÂíåÂéªÈáçÂêàÂπ∂
              format_and_merge() {
                  local title=$1
                  local filename=$2
                  local emoji=$3

                  if [ -s "$filename" ]; then
                      echo "## $emoji $title" >> final_body.txt
                      # ÂêàÂπ∂ÊóßÂÜÖÂÆπÔºàÂ¶ÇÊûúÊúâÂàóË°®È°πÔºâÔºåÂéªÈáçÔºåÂπ∂Ê∑ªÂä† Markdown ÂàóË°®ÂâçÁºÄ
                      # ËøôÈáåÊàë‰ª¨Âè™ËÄÉËôëÊñ∞ÁöÑÂÜÖÂÆπÔºåÊóßÁöÑÂàóË°®È°πÂú®ÊúÄÂêéÂçïÁã¨Â§ÑÁêÜÔºå‰ª•Èò≤Ê†ºÂºèÂÜ≤Á™Å
                      cat "$filename" | sed '/^$/d' | sort -u | sed 's/^/- /' >> final_body.txt
                      echo "" >> final_body.txt
                  fi
              }

              format_and_merge "Êñ∞Â¢ûÂäüËÉΩ (Added)" extracted_add.txt "‚ú®"
              format_and_merge "ÁßªÈô§ÂäüËÉΩ (Removed)" extracted_remove.txt "üóëÔ∏è"
              format_and_merge "‰øÆÂ§ç (Fixed)" extracted_fix.txt "üêû"
              format_and_merge "ÂÖ∂‰ªñÊõ¥Êñ∞ (Other)" extracted_other.txt "üìù"
          
              # 3. ÈôÑÂä†ÊóßÁöÑ Release Body ‰∏≠ÁöÑÂàóË°®È°πÔºåÈò≤Ê≠¢‰∏¢Â§±
              if [ -s old_body.txt ]; then
                  # ÊèêÂèñ old_body.txt ‰∏≠ÊâÄÊúâ‰ª• "-" Êàñ "*" ÂºÄÂ§¥ÁöÑË°åÔºàÂàóË°®È°πÔºâ
                  OLD_CHANGES=$(cat old_body.txt | grep -E '^\s*[-*]' | sort -u)
                  if [ -n "$OLD_CHANGES" ]; then
                      echo "---" >> final_body.txt
                      echo "## ÂéÜÂè≤/ÊóßÁâàÈ°πÁõÆ (Historical/Legacy Items)" >> final_body.txt
                      printf "%s\n" "$OLD_CHANGES" >> final_body.txt
                  fi
              fi
          fi

      # Create or Update Release
      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          RELEASE_FILE=${{ steps.prepare_artifact.outputs.release_artifact }}
          
          # Ê£ÄÊü• Release ÊòØÂê¶Â≠òÂú®
          if gh release view "$MAIN_VERSION" >/dev/null 2>&1; then
            echo "Release $MAIN_VERSION exists, updating..."
            # Êõ¥Êñ∞ Artifact
            gh release upload "$MAIN_VERSION" "$RELEASE_FILE" --clobber
            # Êõ¥Êñ∞ Release ÊèèËø∞
            gh release edit "$MAIN_VERSION" --notes-file final_body.txt
          else
            echo "Release $MAIN_VERSION does not exist, creating..."
            # ÂàõÂª∫Êñ∞ÁöÑ Release
            gh release create "$MAIN_VERSION" "$RELEASE_FILE" --title "$MAIN_VERSION" --notes-file final_body.txt
          fi