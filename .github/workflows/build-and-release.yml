name: Maven Build and Release (Bukkit)

# ä»…åœ¨æ¨é€åˆ° main æˆ– master åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches:
      - main
      - master

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    # è·å– pom.xml ä¸­çš„ä¸»ç‰ˆæœ¬å·
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦è·å–å®Œæ•´çš„å†å²è®°å½•ï¼Œä»¥ä¾¿åç»­çš„æ„å»ºå·å’Œ Changelog é€»è¾‘
          fetch-depth: 0

      # ----------------------------------------
      # 1. æå–ç‰ˆæœ¬ä¿¡æ¯
      # ----------------------------------------
      - name: âš™ï¸ Extract Project Main Version (from pom.xml)
        id: version_extractor
        run: |
          # ä½¿ç”¨ xmllint/sed æå– <version>1.0</version> ä¸­çš„ '1.0'
          MAIN_VERSION=$(xmllint --xpath "/*[local-name()='project']/*[local-name()='version']/text()" pom.xml)
          echo "MAIN_VERSION=${MAIN_VERSION}" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºå†å²ï¼Œç”¨äºæ„å»ºå·é‡ç½®é€»è¾‘
          if git tag -l "${MAIN_VERSION}" | grep -q "${MAIN_VERSION}"; then
            echo "BUILD_TAG_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "BUILD_TAG_EXISTS=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------
      # 2. è®¡ç®—æ„å»ºå·
      # ----------------------------------------
      - name: ğŸ”¢ Get or Reset Build Number
        id: build_number_action
        uses: einaregilsson/build-number@v1
        with:
          # ä½¿ç”¨ä¸»ç‰ˆæœ¬å·ä½œä¸ºå‰ç¼€ï¼Œå®ç°ç‰ˆæœ¬å·å˜åŒ–æ—¶é‡ç½®
          token: ${{ secrets.GITHUB_TOKEN }}
          prefix: ${{ steps.version_extractor.outputs.MAIN_VERSION }}-

      # ----------------------------------------
      # 3. è®¾ç½®ç¯å¢ƒå˜é‡å’Œæœ€ç»ˆç‰ˆæœ¬
      # ----------------------------------------
      - name: ğŸ“ Set Versioning Variables
        id: set_vars
        run: |
          # æœ€ç»ˆçš„ JAR ç‰ˆæœ¬ï¼šä¾‹å¦‚ 1.0.1
          FULL_VERSION="${{ steps.version_extractor.outputs.MAIN_VERSION }}.${{ steps.build_number_action.outputs.build_number }}"
          
          # æ„å»ºå·ï¼Œä¾‹å¦‚ 1
          BUILD_NUMBER="${{ steps.build_number_action.outputs.build_number }}"
          
          # ä¸»ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 1.0
          MAIN_VERSION="${{ steps.version_extractor.outputs.MAIN_VERSION }}"
          
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "MAIN_VERSION=$MAIN_VERSION" >> $GITHUB_OUTPUT
          
          echo "Full JAR Version: $FULL_VERSION"
          echo "Build Number: $BUILD_NUMBER"

      # ----------------------------------------
      # 4. é…ç½® Java ç¯å¢ƒ
      # ----------------------------------------
      - name: â˜• Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'
          cache: maven

      # ----------------------------------------
      # 5. ä¿®æ”¹ plugin.yml å’Œ Maven Manifest
      # ----------------------------------------
      - name: âš™ï¸ Update plugin.yml (Set Version)
        run: |
          # ä½¿ç”¨ sed æ›¿æ¢ plugin.yml ä¸­çš„ version: undefined ä¸ºå®é™…çš„ä¸»ç‰ˆæœ¬å·
          sed -i "s/^version: undefined/version: ${{ steps.set_vars.outputs.MAIN_VERSION }}/g" plugin.yml
          cat plugin.yml # æ‰“å°æ£€æŸ¥ç»“æœ

      - name: ğŸ“¦ Configure Build for Manifest
        # ä½¿ç”¨ build-helper-maven-plugin å†™å…¥ MANIFEST.MF
        run: |
          # å°† MANIFEST.MF å†™å…¥é…ç½®æ·»åŠ åˆ° pom.xml ä¸­
          # Shade æ’ä»¶ä¼šåœ¨ package é˜¶æ®µè¿è¡Œï¼Œæˆ‘ä»¬ä¿®æ”¹ Manifest
          # ç¡®ä¿åœ¨ Shade æ’ä»¶è¿è¡Œå‰ï¼ŒManifest å·²ç»ä¿®æ”¹å¥½
          mvn versions:set-property -Dproperty=project.version -DnewVersion=${{ steps.set_vars.outputs.FULL_VERSION }} -DgenerateBackupPoms=false
          
          # ä½¿ç”¨ build-helper-maven-plugin/maven-jar-plugin æ¥è®¾ç½® Manifest å±æ€§
          # ä¸ºäº†ä¸æ”¹åŠ¨åŸå§‹ pom.xml ç»“æ„ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªä¸´æ—¶æ–¹æ³•ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®ç›´æ¥é…ç½® maven-jar-plugin
          # ç”±äº maven-shade-plugin é»˜è®¤ä¼šä½¿ç”¨ maven-jar-plugin çš„é…ç½®ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå°è¯•ä¿®æ”¹ pom.xml
          
          # è¿™æ˜¯ä¸€ä¸ªæ›´å¯é çš„æ–¹æ³•ï¼šä½¿ç”¨ maven-jar-plugin é…ç½® Manifest å±æ€§
          # æ­¤å¤„ç›´æ¥ä½¿ç”¨ <properties> æ¥ä¼ é€’å˜é‡ç»™ maven-jar-plugin
          
          echo "Setting Manifest properties in pom.xml..."
          
          # ä¸´æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„ pom.xml, æ³¨å…¥ maven-jar-plugin é…ç½®ï¼Œç¡®ä¿ Manifest å†™å…¥
          cat pom.xml | awk '
            /<build>/ { print; print "        <plugins>"; print "            <plugin>"; print "                <groupId>org.apache.maven.plugins</groupId>"; print "                <artifactId>maven-jar-plugin</artifactId>"; print "                <version>3.3.0</version>"; print "                <configuration>"; print "                    <archive>"; print "                        <manifestEntries>"; print "                            <Main-Version>${{ steps.set_vars.outputs.MAIN_VERSION }}</Main-Version>"; print "                            <Build-Number>${{ steps.set_vars.outputs.BUILD_NUMBER }}</Build-Number>"; print "                        </manifestEntries>"; print "                    </archive>"; print "                </configuration>"; print "            </plugin>"; next; }
            /<\/plugins>/ { print "        </plugins>"; next; }
            /<\/build>/ { print; next; }
            { print }
          ' > pom.xml.new
          
          # æ£€æŸ¥æ›¿æ¢ç»“æœ (éœ€è¦äººå·¥æ£€æŸ¥æˆ–æ›´ç²¾ç»†çš„ XML ä¿®æ”¹å·¥å…·)
          # å¯¹äº Bukkit/Spigot é¡¹ç›®ï¼Œé€šå¸¸å¯ä»¥ç›´æ¥åœ¨ <plugins> å†…éƒ¨æ·»åŠ  maven-jar-plugin é…ç½®
          # ä½†ä¸ºäº†å…¼å®¹æ€§ï¼Œæˆ‘ä»¬ç›´æ¥è¿›è¡Œæ„å»ºï¼Œå¹¶ä¾èµ–é»˜è®¤çš„ Shade é…ç½®

      # ----------------------------------------
      # 6. Maven æ„å»º
      # ----------------------------------------
      - name: ğŸ“¦ Build with Maven (with full version)
        run: |
          # ä½¿ç”¨æœ€ç»ˆç‰ˆæœ¬å·æ„å»ºï¼Œç¡®ä¿ Shade æ’ä»¶è¾“å‡ºçš„æ–‡ä»¶åå’Œ MANIFEST.MF æ­£ç¡®
          mvn clean package -Dproject.version=${{ steps.set_vars.outputs.FULL_VERSION }}
          
          # é‡å‘½åæœ€ç»ˆäº§ç‰©ï¼Œæ–¹ä¾¿ä¸Šä¼  Release
          mv target/${{ github.event.repository.name }}-${{ steps.set_vars.outputs.FULL_VERSION }}.jar target/${{ github.event.repository.name }}.jar

      # ----------------------------------------
      # 7. æå– Changelog
      # ----------------------------------------
      - name: ğŸ“ Extract Changelog from Commit Messages
        id: changelog_extractor
        run: |
          # è·å–æœ¬æ¬¡ push çš„æ‰€æœ‰ commit æ¶ˆæ¯
          COMMIT_MESSAGES=$(git log --pretty=format:"%s%n%b" ${{ github.event.before }}..${{ github.event.after }})
          
          CHANGELOG=""
          IFS=$'\n' # è®¾ç½®åˆ†éš”ç¬¦ä¸ºæ¢è¡Œç¬¦
          for LINE in $COMMIT_MESSAGES; do
              # åŒ¹é…ä»¥ [CL] å¼€å¤´çš„è¡Œï¼Œå¹¶æå– [CL] åçš„å†…å®¹
              if [[ "$LINE" =~ ^\[CL\][[:space:]]*(.*)$ ]]; then
                  MESSAGE="${BASH_REMATCH[1]}"
                  if [[ ! -z "$MESSAGE" ]]; then
                      CHANGELOG="${CHANGELOG}* ${MESSAGE}\n"
                  fi
              fi
          done
          
          # ç§»é™¤é¦–å°¾ç©ºç™½ï¼Œå¹¶è½¬ä¹‰å¤šè¡Œå­—ç¬¦ä¸²ä»¥æ”¾å…¥ GitHub Action è¾“å‡º
          ESCAPED_CHANGELOG=$(echo -e "$CHANGELOG" | sed -z 's/\n$//' | sed 's/"/\\"/g' | awk 'BEGIN {ORS="\\n"} {print}' | sed 's/\\n$//')

          echo "Extracted Changelog:"
          echo "$CHANGELOG"
          echo "ESCAPED_CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$ESCAPED_CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ----------------------------------------
      # 8. å‘å¸ƒ Release (æ¡ä»¶è¿½åŠ  Changelog æˆ–åˆ›å»ºæ–° Release)
      # ----------------------------------------
      # ä»…åœ¨ä¸»ç‰ˆæœ¬å·æ ‡ç­¾ä¸å­˜åœ¨æ—¶åˆ›å»ºæ–°çš„ Release
      - name: ğŸ†• Create New Release and Tag
        if: steps.version_extractor.outputs.BUILD_TAG_EXISTS == 'false'
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set_vars.outputs.MAIN_VERSION }}
          name: Release ${{ steps.set_vars.outputs.MAIN_VERSION }}
          body: |
            ## ğŸ‰ **Release v${{ steps.set_vars.outputs.MAIN_VERSION }}**
            
            This is the initial release for version **${{ steps.set_vars.outputs.MAIN_VERSION }}**.
            
            ### Changelog
            ${{ steps.changelog_extractor.outputs.ESCAPED_CHANGELOG }}
          draft: false
          prerelease: false
          # ä¸Šä¼ æœ€ç»ˆçš„ JAR æ–‡ä»¶
          files: target/${{ github.event.repository.name }}.jar

      # ä»…åœ¨ä¸»ç‰ˆæœ¬å·æ ‡ç­¾å·²å­˜åœ¨æ—¶æ›´æ–°å·²æœ‰çš„ Release (è¿½åŠ  Changelog)
      - name: ğŸ“ Update Existing Release (Append Changelog)
        if: steps.version_extractor.outputs.BUILD_TAG_EXISTS == 'true' && steps.changelog_extractor.outputs.ESCAPED_CHANGELOG != ''
        uses: meeDamian/github-release@v2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.set_vars.outputs.MAIN_VERSION }}
          append_body: |
            ---
            **Build #${{ steps.set_vars.outputs.BUILD_NUMBER }}**
            *Version: ${{ steps.set_vars.outputs.FULL_VERSION }}*
            
            ### Changes in this Build
            ${{ steps.changelog_extractor.outputs.ESCAPED_CHANGELOG }}
          # ä¸Šä¼ æœ€æ–°çš„ JAR æ–‡ä»¶ï¼Œè¦†ç›–æ—§çš„ Assets
          allow_override: true
          assets: target/${{ github.event.repository.name }}.jar

      # ----------------------------------------
      # 9. ç»´æŠ¤æ„å»ºå·æ ‡ç­¾
      # ----------------------------------------
      - name: ğŸ·ï¸ Update Build Number Tag
        # æ— è®ºæ˜¯å¦åˆ›å»ºäº†æ–°çš„ Releaseï¼Œéƒ½éœ€è¦æ›´æ–°æ„å»ºå·æ ‡ç­¾ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡æ„å»ºå·æ­£ç¡®è‡ªå¢
        run: |
          git tag -f "${{ steps.set_vars.outputs.MAIN_VERSION }}-${{ steps.set_vars.outputs.BUILD_NUMBER }}"
          git push -f origin "${{ steps.set_vars.outputs.MAIN_VERSION }}-${{ steps.set_vars.outputs.BUILD_NUMBER }}"