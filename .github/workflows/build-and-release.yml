name: Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Java 17
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          architecture: x64

      # Force set JAVA_HOME
      - name: Force JAVA_HOME
        run: |
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "$JAVA_HOME/bin" >> $GITHUB_PATH

      # Print current java version
      - name: Check Java Version
        run: java -version

      # Read main version from pom.xml
      - name: Read main version
        id: read_version
        run: |
          MAIN_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "main_version=$MAIN_VERSION" >> $GITHUB_OUTPUT

      # Get short commit SHA as internal build number
      - name: Get commit SHA
        id: commit_sha
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      # Rewrite plugin.yml version
      - name: Rewrite plugin.yml version
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          sed -i "s/^version: .*/version: ${MAIN_VERSION}/" src/main/resources/plugin.yml

      # Build with Maven (internal build number passed as property)
      - name: Build with Maven
        run: |
          COMMIT_SHA=${{ steps.commit_sha.outputs.commit_sha }}
          mvn -B clean package -DskipTests -DbuildNumber=$COMMIT_SHA

      # Prepare Release artifact
      - name: Prepare Release artifact
        id: prepare_artifact
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          SHADOW_JAR=$(ls target/*-shaded.jar | head -n1)
          RELEASE_FILE="BaseKit-${MAIN_VERSION}.jar"
          cp "$SHADOW_JAR" "$RELEASE_FILE"
          echo "release_artifact=$RELEASE_FILE" >> $GITHUB_OUTPUT

      # Extract Changelog
      - name: Extract Changelog
        id: extract_changelog
        run: |
          BEFORE_SHA=${{ github.event.before }}
          AFTER_SHA=${{ github.event.after }}

          > extracted_add.txt
          > extracted_remove.txt
          > extracted_fix.txt
          > extracted_other.txt
          
          if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "Detected initial push or force push â€” using last 10 commits"
            COMMITS=$(git log -n 10 --pretty=format:"%B")
          else
            COMMITS=$(git log $BEFORE_SHA..$AFTER_SHA --pretty=format:"%B")
          fi
          
          while IFS= read -r line; do
            CLEAN_LINE=$(echo "$line" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')

            if echo "$CLEAN_LINE" | grep -iq "^\[ADD\]"; then
              ITEM=$(echo "$CLEAN_LINE" | sed -E 's/^\[ADD\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_add.txt
            elif echo "$CLEAN_LINE" | grep -iq "^\[REMOVE\]"; then
              ITEM=$(echo "$CLEAN_LINE" | sed -E 's/^\[REMOVE\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_remove.txt
            elif echo "$CLEAN_LINE" | grep -iq "^\[FIX\]"; then
              ITEM=$(echo "$CLEAN_LINE" | sed -E 's/^\[FIX\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_fix.txt
            elif echo "$CLEAN_LINE" | grep -iq "^\[OTHER\]"; then
              ITEM=$(echo "$CLEAN_LINE" | sed -E 's/^\[OTHER\]\s*//I')
              printf "%s\n" "$ITEM" >> extracted_other.txt
            fi
          done <<< "$COMMITS"

      # Merge Changelog and Format
      - name: Merge Changelog
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          
          gh release view "$MAIN_VERSION" --json body --jq '.body' > old_body.txt 2>/dev/null || true
          
          if [ -s extracted_add.txt ] || [ -s extracted_remove.txt ] || [ -s extracted_fix.txt ] || [ -s extracted_other.txt ]; then
              HAS_NEW_CHANGES=true
          else
              HAS_NEW_CHANGES=false
          fi
          
          if [ "$HAS_NEW_CHANGES" = false ] && [ -s old_body.txt ]; then
              echo "No new [ADD/REMOVE/FIX/OTHER] tags found. Retaining existing Release body."
              cp old_body.txt final_body.txt
          
          else
              > final_body.txt
          
              echo "# Changelog" >> final_body.txt
              echo "" >> final_body.txt
          
              if [ -s old_body.txt ]; then
                  OLD_PRE_BODY=$(cat old_body.txt | sed '/^# Changelog/,$d')
                  if [ -n "$OLD_PRE_BODY" ]; then
                      printf "%s\n\n" "$OLD_PRE_BODY" >> final_body.txt
                  fi
              fi

              format_and_merge() {
                  local title=$1
                  local filename=$2
                  local emoji=$3

                  if [ -s "$filename" ]; then
                      echo "## $emoji $title" >> final_body.txt
                      cat "$filename" | sed '/^$/d' | sort -u | sed 's/^/- /' >> final_body.txt
                      echo "" >> final_body.txt
                  fi
              }

              format_and_merge "Add" extracted_add.txt "âœ¨"
              format_and_merge "Remove" extracted_remove.txt "ðŸ—‘ï¸"
              format_and_merge "Fix" extracted_fix.txt "ðŸž"
              format_and_merge "Other" extracted_other.txt "ðŸ“"
          
              if [ -s old_body.txt ]; then
                  OLD_CHANGES=$(cat old_body.txt | grep -E '^\s*[-*]' | sort -u)
                  if [ -n "$OLD_CHANGES" ]; then
                      echo "---" >> final_body.txt
                      echo "## Historical/Legacy Items" >> final_body.txt
                      printf "%s\n" "$OLD_CHANGES" >> final_body.txt
                  fi
              fi
          fi

      # Create or Update Release
      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          RELEASE_FILE=${{ steps.prepare_artifact.outputs.release_artifact }}
          
          if gh release view "$MAIN_VERSION" >/dev/null 2>&1; then
            echo "Release $MAIN_VERSION exists, updating..."
            gh release upload "$MAIN_VERSION" "$RELEASE_FILE" --clobber
            gh release edit "$MAIN_VERSION" --notes-file final_body.txt
          else
            echo "Release $MAIN_VERSION does not exist, creating..."
            gh release create "$MAIN_VERSION" "$RELEASE_FILE" --title "$MAIN_VERSION" --notes-file final_body.txt
          fi