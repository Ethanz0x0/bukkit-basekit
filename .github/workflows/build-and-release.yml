name: Maven Build and Release (Bukkit)

# Only run on pushes to main/master
on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Extract main version from pom.xml
        id: version_extractor
        run: |
          # extract the first <version>...</version> text under project
          MAIN_VERSION=$(xmllint --xpath "/*[local-name()='project']/*[local-name()='version']/text()" pom.xml 2>/dev/null || true)
          if [ -z "$MAIN_VERSION" ]; then
            echo "Could not find <version> in pom.xml" >&2
            exit 1
          fi
          echo "MAIN_VERSION=$MAIN_VERSION" >> $GITHUB_OUTPUT

          # check whether a release/tag for the main version already exists
          if git ls-remote --tags origin refs/tags/$MAIN_VERSION | grep -q "$MAIN_VERSION"; then
            echo "BUILD_TAG_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "BUILD_TAG_EXISTS=false" >> $GITHUB_OUTPUT
          fi

      - name: üî¢ Get or Reset Build Number (prefix = MAIN_VERSION-)
        id: build_number_action
        uses: einaregilsson/build-number@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prefix: ${{ steps.version_extractor.outputs.MAIN_VERSION }}-

      - name: üìù Set versioning variables
        id: set_vars
        run: |
          MAIN_VERSION=${{ steps.version_extractor.outputs.MAIN_VERSION }}
          BUILD_NUMBER=${{ steps.build_number_action.outputs.build_number }}
          FULL_VERSION="$MAIN_VERSION.$BUILD_NUMBER"

          echo "MAIN_VERSION=$MAIN_VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT

          echo "Full JAR Version: $FULL_VERSION"
          echo "Build Number: $BUILD_NUMBER"

      - name: ‚òï Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'
          cache: maven

      - name: ‚öôÔ∏è Update plugin.yml to main version
        run: |
          # replace a line like: version: undefined  or version: "..."
          if [ -f plugin.yml ]; then
            sed -E -i "s/^(version:\s*).*/\1${{ steps.set_vars.outputs.MAIN_VERSION }}/" plugin.yml || true
            echo "Updated plugin.yml:" 
            sed -n '1,120p' plugin.yml || true
          else
            echo "plugin.yml not found, skipping" >&2
          fi

      - name: üì¶ Set pom version to full version and build
        run: |
          # change project.version to the FULL_VERSION for this build
          mvn -q -DgenerateBackupPoms=false versions:set -DnewVersion=${{ steps.set_vars.outputs.FULL_VERSION }}

      - name: üîß Build with Maven (package using shade)
        run: |
          mvn -q clean package

      - name: üìù Inject Main-Version and Build-Number into JAR manifest
        run: |
          # find the produced jar (shade usually produces *-shaded.jar or artifactId-version.jar)
          JAR=$(ls target/*.jar 2>/dev/null | head -n 1 || true)
          if [ -z "$JAR" ]; then
            echo "No jar found in target/" >&2
            exit 1
          fi

          echo "Main-Version: ${{ steps.set_vars.outputs.MAIN_VERSION }}" > manifest.tmp
          echo "Build-Number: ${{ steps.set_vars.outputs.BUILD_NUMBER }}" >> manifest.tmp

          # Update the jar's manifest (jar tool will merge this manifest entries)
          jar ufm "$JAR" manifest.tmp || true
          rm -f manifest.tmp

          # normalize final artifact name
          REPO_NAME=${{ github.event.repository.name }}
          mv "$JAR" "target/${REPO_NAME}.jar" || true
          ls -l target/${{ github.event.repository.name }}*.jar || true

      - name: üìù Extract [CL] changelog lines from commits
        id: changelog_extractor
        run: |
          # get commits for this push
          BEFORE=${{ github.event.before }}
          AFTER=${{ github.event.after }}

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            # new branch or initial commit; take last 50 commits as fallback
            RANGE="HEAD~50..HEAD"
          else
            RANGE="$BEFORE..$AFTER"
          fi

          # collect lines starting with [CL]
          CHANGELOG_TMP=$(git log --pretty=format:%B $RANGE | sed -n 's/\r//g' | awk 'BEGIN{RS="\n"}{if ($0 ~ /^\[CL\]/) print substr($0, index($0,$0)+4)}')

          # more robust extraction: find any occurrence of lines starting with [CL]
          CHANGELOG=$(git log --pretty=format:%B $RANGE | awk 'BEGIN{FS="\n"} {for(i=1;i<=NF;i++){ if ($i ~ /^\[CL\]/){ line = substr($i,5); gsub(/^\s+/,"",line); if (length(line)>0) print line }}}' | sed '/^\s*$/d' | awk '!seen[$0]++')

          if [ -z "$CHANGELOG" ]; then
            echo "NO_CHANGELOG=true" >> $GITHUB_OUTPUT
            echo "ESCAPED_CHANGELOG=" >> $GITHUB_OUTPUT
            echo "No [CL] entries found."
          else
            # escape newlines for GH Actions output
            ESCAPED=$(echo -e "$CHANGELOG" | sed 's/"/\\"/g' | awk 'BEGIN{ORS="\\n"} {print}')
            echo "NO_CHANGELOG=false" >> $GITHUB_OUTPUT
            echo "ESCAPED_CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "$ESCAPED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Extracted changelog:" 
            echo "$CHANGELOG"
          fi

      - name: üÜï Create or update Release (tag = main version) and upload jar
        uses: peter-evans/create-or-update-release@v3
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.set_vars.outputs.MAIN_VERSION }}
          release_name: "Release ${{ steps.set_vars.outputs.MAIN_VERSION }}"
          body: |
            ## Build ${{ steps.set_vars.outputs.BUILD_NUMBER }} ‚Äî Version ${{ steps.set_vars.outputs.FULL_VERSION }}

            ${{ steps.changelog_extractor.outputs.ESCAPED_CHANGELOG }}
          files: target/${{ github.event.repository.name }}.jar
          draft: false
          prerelease: false
          append_body: true

      - name: üè∑Ô∏è Update build-number tag (MAINVERSION-BUILDNUMBER)
        run: |
          TAG_NAME="${{ steps.set_vars.outputs.MAIN_VERSION }}-${{ steps.set_vars.outputs.BUILD_NUMBER }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f "$TAG_NAME"
          git push -f origin "$TAG_NAME"