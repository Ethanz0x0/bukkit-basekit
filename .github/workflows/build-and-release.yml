name: Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup JDK 8
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      # 3. Read main version from pom.xml
      - name: Read main version from pom.xml
        id: read_version
        run: |
          MAIN_VERSION=$(grep -oPm1 "(?<=<version>)[^<]+" pom.xml | head -n1)
          echo "main_version=$MAIN_VERSION" >> $GITHUB_OUTPUT

      # 4. Get short commit SHA as internal build number
      - name: Get short commit SHA
        id: commit_sha
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      # 5. Rewrite plugin.yml version
      - name: Rewrite plugin.yml version
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          sed -i "s/version: .*/version: ${MAIN_VERSION}/" src/main/resources/plugin.yml

      # 6. Maven build
      - name: Build with Maven
        run: mvn -B clean package -DskipTests \
          -DbuildNumber=${{ steps.commit_sha.outputs.commit_sha }}

      # 7. Rename shaded artifact for internal reference
      - name: Rename artifact
        id: rename
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          COMMIT_SHA=${{ steps.commit_sha.outputs.commit_sha }}
          # 内部文件名带 commit id 用于区分构建（可选）
          INTERNAL_FILE="BaseKit-${MAIN_VERSION}-${COMMIT_SHA}.jar"
          JAR=$(ls target/*-shaded.jar | head -n1)
          cp "$JAR" "$INTERNAL_FILE"
          echo "internal_artifact=$INTERNAL_FILE" >> $GITHUB_OUTPUT
          # Release 上传文件名固定为 BaseKit-<主版本号>.jar
          RELEASE_FILE="BaseKit-${MAIN_VERSION}.jar"
          cp "$JAR" "$RELEASE_FILE"
          echo "release_artifact=$RELEASE_FILE" >> $GITHUB_OUTPUT

      # 8. Extract Changelog from recent commits
      - name: Extract Changelog
        id: changelog
        run: |
          COMMITS=$(git log -n 20 --pretty=format:"%s")
          CHANGELOG=""
          while read -r line; do
            if echo "$line" | grep -iq "^\[CL\]"; then
              ITEM=$(echo "$line" | sed -E 's/^\[CL\]\s*//I')
              CHANGELOG="${CHANGELOG}${ITEM}\n"
            fi
          done <<< "$COMMITS"
          echo -e "$CHANGELOG" > extracted_changelog.txt

      # 9. Merge Changelog and format
      - name: Merge Changelog and format
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          gh release view "$MAIN_VERSION" --json body --jq '.body' > old_body.txt 2>/dev/null || true
          MERGED=$(cat old_body.txt extracted_changelog.txt | sed '/^$/d' | sort -u)
          {
            echo "# Changelog"
            echo ""
            while read -r line; do
              if [ -n "$line" ]; then
                echo "- $line"
              fi
            done <<< "$MERGED"
          } > final_body.txt

      # 10. Create or Update Release
      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          RELEASE_FILE=${{ steps.rename.outputs.release_artifact }}
          if gh release view "$MAIN_VERSION" >/dev/null 2>&1; then
            gh release upload "$MAIN_VERSION" "$RELEASE_FILE" --clobber
            gh release edit "$MAIN_VERSION" --notes-file final_body.txt
          else
            gh release create "$MAIN_VERSION" "$RELEASE_FILE" --title "$MAIN_VERSION" --notes-file final_body.txt