name: Build & Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup JDK
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      # 3. 读取主版本号（pom.xml 中的 <version>）
      - name: Read main version from pom.xml
        id: read_version
        run: |
          MAIN_VERSION=$(xmllint --xpath "string(//project/version)" pom.xml)
          echo "main_version=$MAIN_VERSION" >> $GITHUB_OUTPUT

      # 4. 获取构建号（根据主版本分组存储）
      - name: Determine build number
        id: build_number
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}

          KEY="build-${MAIN_VERSION}"
          # 从 GitHub Release 中尝试读取构建号
          LAST_BUILD=$(gh release view "$MAIN_VERSION" --json assets --jq '.assets[].name' 2>/dev/null | grep -oP "(?<=${MAIN_VERSION}-)\d+(?=\.jar)" | sort -n | tail -1)

          if [ -z "$LAST_BUILD" ]; then
            BUILD_NUMBER=1
          else
            BUILD_NUMBER=$((LAST_BUILD + 1))
          fi

          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      # 5. 替换 plugin.yml 的 version 字段（使用主版本号）
      - name: Rewrite plugin.yml version
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          sed -i "s/version: .*/version: ${MAIN_VERSION}/" plugin.yml

      # 6. 将 BUILD_NUMBER 写入 Maven 使用的环境变量
      - name: Set build number env
        run: echo "BUILD_NUMBER=${{ steps.build_number.outputs.build_number }}" >> $GITHUB_ENV

      # 7. Build jar（Shade）
      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      # 8. 重命名 artifact（BaseKit-主版本-构建号.jar）
      - name: Rename artifact
        id: rename
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          BUILD_NUMBER=${{ steps.build_number.outputs.build_number }}
          OUT="BaseKit-${MAIN_VERSION}-${BUILD_NUMBER}.jar"

          cp target/*-shaded.jar "$OUT"
          echo "artifact=$OUT" >> $GITHUB_OUTPUT

      # 9. 提取本次构建相关 commit 的 changelog（仅 [CL] 开头）
      - name: Extract Changelog
        id: changelog
        run: |
          # 读取最新构建到当前的 commits
          COMMITS=$(git log -n 20 --pretty=format:"%s")

          echo "--- COMMITS ---"
          echo "$COMMITS"

          # 提取 [CL] 内容（大小写不敏感）
          CHANGELOG=""
          while read -r line; do
            if echo "$line" | grep -iq "^\[CL\]"; then
              ITEM=$(echo "$line" | sed -E 's/^\[CL\]\s*//I')
              CHANGELOG="${CHANGELOG}${ITEM}\n"
            fi
          done <<< "$COMMITS"

          echo -e "$CHANGELOG" > extracted_changelog.txt

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat extracted_changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 10. 读取旧 Release 的 Changelog 并合并（去重）
      - name: Merge Changelog
        id: merge
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}

          # 获取旧 changelog
          gh release view "$MAIN_VERSION" --json body --jq '.body' > old_body.txt 2>/dev/null || true

          echo "Old Release Body:"
          cat old_body.txt || true

          # 抽取旧 changelog（第一段）
          awk '/^---/{flag=flag?0:1;next} flag' old_body.txt > old_changelog.txt || true

          # 合并并去重
          cat old_changelog.txt extracted_changelog.txt | sed '/^$/d' | sort -u > merged_changelog.txt

          echo "---" > final_body.txt
          cat merged_changelog.txt >> final_body.txt
          echo "---" >> final_body.txt
          echo "Content" >> final_body.txt

      # 11. 创建或更新 Release
      - name: Create or Update Release
        run: |
          MAIN_VERSION=${{ steps.read_version.outputs.main_version }}
          ARTIFACT=${{ steps.rename.outputs.artifact }}

          if gh release view "$MAIN_VERSION" >/dev/null 2>&1; then
            gh release upload "$MAIN_VERSION" "$ARTIFACT" --clobber
            gh release edit "$MAIN_VERSION" --notes-file final_body.txt
          else
            gh release create "$MAIN_VERSION" "$ARTIFACT" --title "$MAIN_VERSION" --notes-file final_body.txt
          fi